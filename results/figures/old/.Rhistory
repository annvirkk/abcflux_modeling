dev.off()
obspred$Disturbance2 <- as.character(obspred$Disturbance)
obspred$Disturbance2 <- ifelse(obspred$Disturbance2=="Drainage", "NA/No", obspred$Disturbance2)
p13 <- ggplot(obspred) + geom_bin2d(aes(x=pred, y=obs),bins=50) + geom_abline(slope = 1) +
xlim(scale_min, scale_max) + ylim(scale_min, scale_max)  + theme_pub +
scale_fill_viridis(direction=-1,  trans = 'log', labels = scales::number_format(accuracy = 1)) + # could add trans='log' but then counts are harder to interpret?
labs(fill="Log counts") + facet_wrap(~Disturbance2) + xlab(xlab) + ylab(ylab)
print(p13)
dev.copy(png, paste(i, m, km, "train_loocv_predperf_bins_disturbance.png", sep="_"), width=900, height=750)
dev.off()
### Model fit - looks great, no need to visualize
predtest <- predict(mod, obspred)
obspred$predtest <- predtest
ggplot(obspred) + geom_bin2d(aes(x=predtest, y=obs), bins=30) + geom_abline(slope = 1) +
xlim(scale_min, scale_max) + ylim(scale_min, scale_max) + facet_wrap(~Country)
# if grouped to annual mean...
obspredtest <- obspred %>% group_by(Study_ID_Short, Country, Biome, Meas_year) %>% summarize(obs_sum=sum(obs), predtest_sum=sum(predtest), n=n()) %>% filter(n==12)
ggplot(obspredtest) + geom_bin2d(aes(x=predtest_sum, y=obs_sum), bins=30) + geom_abline(slope = 1) +
xlim(scale_min, scale_max) + ylim(scale_min, scale_max) + facet_wrap(~paste(Country, Biome))
# Sweden and USA have quite many source observations that are predicted as larger Co2 sources
obspredtest_long <- pivot_longer(obspredtest, cols=c(5,6))
ggplot(obspredtest_long) + geom_density(aes(value, fill=name, color=name), alpha=0.5) + facet_wrap(~Country) + facet_wrap(~paste(Country, Biome)) + geom_vline(xintercept=0)
### Visualize with boxplots
str(obspred)
obspred_long <- pivot_longer(obspred, c("obs", "pred", "predtest"))
obspred_long$name <- ifelse(obspred_long$name=="obs", "Observed", obspred_long$name)
obspred_long$name <- ifelse(obspred_long$name=="pred", "Predicted (CV)", obspred_long$name)
obspred_long$name <- ifelse(obspred_long$name=="predtest", "Predicted (no CV)", obspred_long$name)
obspred_long$Biome_name <- paste(obspred_long$Biome, obspred_long$name)
obspred_long$Biome_name <- factor(obspred_long$Biome_name, levels=c("Boreal Observed", "Boreal Predicted (no CV)", "Boreal Predicted (CV)",
"Tundra Observed", "Tundra Predicted (no CV)", "Tundra Predicted (CV)"))
# Define x and y lab titles for the plot
if (i=="GPP_gC_m2") {
ylab2 = expression(paste("GPP g C m"^{-2}, month^{-1}))
}
if (i=="NEE_gC_m2") {
ylab2 = expression(paste("NEE g C m"^{-2}, month^{-1}))
}
if (i=="Reco_gC_m2") {
ylab2 = expression(paste("Reco g C m"^{-2}, month^{-1}))
}
p14 <- ggplot(obspred_long) + geom_boxplot(aes(x=factor(Interval), y=value), col="black") + facet_wrap(~paste(Biome_name))  + theme_pub + ylab(ylab2) + xlab("Month")
print(p14)
dev.copy(png, paste(i, m, km, "train_loocv_predperf_boxplot.png", sep="_"), width=900, height=750)
dev.off()
print("final pred perf figures done")
# extract varimp results - this should work
all_varImp <- caret::varImp(mod$finalModel) %>% data.frame()
all_varImp
print("model loop done")
all_varImp$Variable2 <- row.names(all_varImp)
all_varImp$Importance <- all_varImp$Overall
# change the name
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="srad_terraclimate_sites", "Solar radiation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="vpd_terraclimate_sites", "Vapor pressure deficit", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="pr_terraclimate_sites", "Precipitation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="pdsi_terraclimate_sites", "PDSI", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="tmean_TerraClimate_averages", "Mean annual air temperature over 1961-1990", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="ppt_TerraClimate_averages", "Mean annual precipitation over 1961-1990", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="trend_20yrprior_terra_change_id", "Rolling last 20-year air temperature trend", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="terra_trend_19601990", "Annual mean air temperature trend over 1961-1990", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="ndvi_trend_19812010", "June-August mean NDVI trend over 1982-2010", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Barrow_CO2_conc_Barrow_CO2conc", "Atmospheric CO2", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Snow.cover_era5_soilmoist_temp_snow", "Snow cover", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Snow.depth_era5_soilmoist_temp_snow", "Snow depth", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Soil.temperature.level.1_era5_soilmoist_temp_snow", "Soil temperature", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Volumetric.soil.water.layer.1_era5_soilmoist_temp_snow", "Volumetric soil water", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="NDVI_whittaker_constant_monthly_mean", "NDVI", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="LST_Day_1km_MOD11A2v006_LST_Day_sites_low_quality", "Land surface temperature (daytime)", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="water_ground_MCD43A4_annual_water_ground_sites_low_quality", "June-August average NDWI", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="water_vegetation_MCD43A4_annual_water_vegetation_sites_low_quality", "June-August average NDII", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="dtm_cti_merit.dem_m_250m_s0..0cm_2018_v1.0_MERIT_topo_indices_250m", "Compound topographic index", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="dtm_rough.scale_merit.dem_m_250m_s0..0cm_2018_v1.0_MERIT_topo_indices_250m", "Topographic roughness scale", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="aboveground_biomass_carbon_2010_Above_belowground_biomass", "Aboveground biomass", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="belowground_biomass_carbon_2010_Above_belowground_biomass", "Belowground biomass", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonTree_Vegetation_MOD44B_sites", "Percent non-tree vegetation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonVegetated_MOD44B_sites", "Percent-non-vegetated", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_Tree_Cover_MOD44B_sites", "Percent tree cover", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="ESACCI_cavm_general_ESAwaterfix_broadevfix_mixfix_cropfix_nowaterglacier_ESACCI_CAVM_merged", "Vegetation type", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="PHIHOX_M_sl1_250m_ll_SoilGrids", "Soil pH", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="BLDFIE_M_sl1_250m_ll_SoilGrids", "Soil bulk density", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="sol_watercontent.1500kPa_usda.3c2a1a_m_250m_b0..0cm_1950..2017_v0.1_SoilGrids_watercontent", "Soil water content", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Number_of_days_since_fire_classes_MCD64A1_sites_cleaned", "Time since fire", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="TKWP_Thermokarst", "Wetland thermokarst", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="TKHP_Thermokarst", "Hillslope thermokarst", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="forest_age_class_forest_age_sites", "Time since fire", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="UiO_PEX_PERPROB_5.0_20181128_2000_2016_NH_UiO_PEX_20181128_2000_2016_NH", "Permafrost probability", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="SoilGrids_SOC_SoilGrids_SOCstock", "Soil organic carbon stock", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="SMMR_SSMIS_thaw_days_NTSG_FT_SMMR_SSMIS_25km", "Number of thaw days", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_TreeCover_AVHRR_VCF5KYR", "Percent tree cover", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonTree_Vegetation_AVHRR_VCF5KYR", "Percent non-tree vegetation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonVegetated_AVHRR_VCF5KYR", "Percent non-vegetated", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Number_of_days_since_fire_classes_gfed_monthly_calc", "Vegetation age", all_varImp$Variable2)
all_varImp3 <- all_varImp[, sort(Importance)]
all_varImp
all_varImp3 <- all_varImp[, sort(all_varImp$Importance)]
all_varImp3 <- all_varImp[sort(all_varImp$Importance),
p1 <- ggplot(all_varImp) + geom_bar(aes(x=Variable2, y=Importance), stat="identity", color="blue")   +
coord_flip() +
theme_pub #+ ggtitle(title2)
# Print out
setwd("D:/repos/abcflux_modeling/results/figures/")
print(p1)
dev.copy(png, paste( i, km,  "qrf_vip.png", sep="_"), width=1300, height=1100)
dev.off()
# EPS
# Print out
setwd("D:/repos/abcflux_modeling/results/figures/")
ggsave(paste( i, km,  "qrf_vip.eps", sep="_"), device=cairo_ps, p1, width=35, height=23, units=c("cm"))
write.csv(all_varImp, paste("D:/repos/abcflux_modeling/results/", i, km, "qrf_vip.csv", sep="_"), row.names=FALSE)
} # km loop done
print("km loop done")
}
####### TEMPORARILY UNCOMMENTED
### Partial dependence plots need to be done in a separate loop
for (i in resp_vars) {
for (km in kms) {
# km <- "1km"
# i <- "NEE_gC_m2"
# i <- "GPP_gC_m2"
# i <- "Reco_gC_m2"
# models
mod <- readRDS(paste0("D:/repos/abcflux_modeling/results/", paste(i,  km, "qrf_train_loocv", sep="_"), ".rds"))
# selected vars
if (km=="1km") {
Selected_vars <- Baseline_vars_1km
} else {
Selected_vars <- Baseline_vars_20km
}
nvars <- length(Selected_vars)
# model training data
# Add data
# remove NA across columns for 1 and 20 km datasets
modeldata2 <- d[,c("Study_ID_Short", "id", i, Baseline_vars_1km)]
modeldata1 <- na.omit(modeldata2) # only 86 obs
sapply(modeldata1, function(x) sum(is.na(x))) # no missing data
print("1 km data set:")
print(nrow(modeldata1))
modeldata2 <- d[,c("Study_ID_Short", "id", i, Baseline_vars_20km)]
modeldata2 <- na.omit(modeldata2) # only 86 obs
sapply(modeldata2, function(x) sum(is.na(x))) # no missing data
print("20 km data set:")
print(nrow(modeldata2))
# create a row ID
modeldata1$samplerow <- seq(1, length(modeldata1$Study_ID_Short), by=1)
# create a row ID
modeldata2$samplerow <- seq(1, length(modeldata2$Study_ID_Short), by=1)
# # Extract the final model details: GBM
preds <- mod$pred %>% data.frame()
if (km=="1km") {
obspred <- merge(modeldata1, preds, by.x="samplerow", by.y="rowIndex")
#plot(obspred$NEE_gC_m2, obspred$obs)
} else {
obspred <- merge(modeldata2, preds, by.x="samplerow", by.y="rowIndex")
#plot(obspred$NEE_gC_m2, obspred$obs)
}
library("randomForest")
for (nvar in 1:nvars) {
pd1 <- partial(mod, pred.var = Selected_vars[nvar], train=obspred)  # don't set plot = TRUE
rug_data <- obspred[Selected_vars[nvar]]
# variable names
# change the name
Selected_vars2 <- Selected_vars
Selected_vars2 <- ifelse(Selected_vars2=="srad_terraclimate_sites", "Solar radiation/10 W m-2	", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="vpd_terraclimate_sites", "Vapor pressure deficit/100 kPa", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="pr_terraclimate_sites", "Precipitation mm", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="pdsi_terraclimate_sites", "PDSI/100", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="tmean_TerraClimate_averages", "Mean annual air temperature over 1961-1990 °C", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="ppt_TerraClimate_averages", "Mean annual precipitation over 1961-1990 mm", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="trend_20yrprior_terra_change_id", "Rolling last 20-year air temperature trend/10 °C", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="terra_trend_19601990", "Annual mean air temperature trend over 1961-1990/10 °C", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="ndvi_trend_19812010", "June-August mean NDVI trend over 1982-2010", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Barrow_CO2_conc_Barrow_CO2conc", "Atmospheric CO2", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Snow.cover_era5_soilmoist_temp_snow", "Snow cover %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Snow.depth_era5_soilmoist_temp_snow", "Snow depth m", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Soil.temperature.level.1_era5_soilmoist_temp_snow", "Soil temperature Kelvin", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Volumetric.soil.water.layer.1_era5_soilmoist_temp_snow", "Volumetric soil water m3 m-3", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="NDVI_whittaker_constant_monthly_mean", "NDVI", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="LST_Day_1km_MOD11A2v006_LST_Day_sites_low_quality", "Land surface temperature (daytime) Kelvin", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="water_ground_MCD43A4_annual_water_ground_sites_low_quality", "June-August average NDWI", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="water_vegetation_MCD43A4_annual_water_vegetation_sites_low_quality", "June-August average NDII", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="dtm_cti_merit.dem_m_250m_s0..0cm_2018_v1.0_MERIT_topo_indices_250m", "Compound topographic index", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="dtm_rough.scale_merit.dem_m_250m_s0..0cm_2018_v1.0_MERIT_topo_indices_250m", "Topographic roughness scale", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="aboveground_biomass_carbon_2010_Above_belowground_biomass", "Aboveground biomass MgC ha-1", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="belowground_biomass_carbon_2010_Above_belowground_biomass", "Belowground biomass MgC ha-1", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Percent_NonTree_Vegetation_MOD44B_sites", "Percent non-tree vegetation %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Percent_NonVegetated_MOD44B_sites", "Percent-non-vegetated %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Percent_Tree_Cover_MOD44B_sites", "Percent tree cover %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="ESACCI_cavm_general_ESAwaterfix_broadevfix_mixfix_cropfix_nowaterglacier_ESACCI_CAVM_merged", "Vegetation type", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="PHIHOX_M_sl1_250m_ll_SoilGrids", "Soil pH", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="BLDFIE_M_sl1_250m_ll_SoilGrids", "Soil bulk density kg m-3", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="sol_watercontent.1500kPa_usda.3c2a1a_m_250m_b0..0cm_1950..2017_v0.1_SoilGrids_watercontent", "Soil water content %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Number_of_days_since_fire_classes_MCD64A1_sites_cleaned", "Time since fire (no burn - old burn)", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="TKWP_Thermokarst", "Wetland thermokarst (low - high coverage)", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="TKHP_Thermokarst", "Hillslope thermokarst (low - high coverage)", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="forest_age_class_forest_age_sites", "Vegetation age (old - young)", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="UiO_PEX_PERPROB_5.0_20181128_2000_2016_NH_UiO_PEX_20181128_2000_2016_NH", "Permafrost probability %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="SoilGrids_SOC_SoilGrids_SOCstock", "Soil organic carbon stock Tonnes ha-1", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="SMMR_SSMIS_thaw_days_NTSG_FT_SMMR_SSMIS_25km", "Number of thaw days", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Percent_TreeCover_AVHRR_VCF5KYR", "Percent tree cover %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Percent_NonTree_Vegetation_AVHRR_VCF5KYR", "Percent non-tree vegetation %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Percent_NonVegetated_AVHRR_VCF5KYR", "Percent non-vegetated %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Number_of_days_since_fire_classes_gfed_monthly_calc", "Time since fire (no burn - old burn)", Selected_vars2)
if (!is.factor(obspred[, Selected_vars[nvar]])) {
pdp_plot1 <- ggplot(pd.all1, aes(x=pd.all1[, 1], y=pd.all1[, 2])) +
geom_line(size=1) + theme_pub  +labs(y="yhat", x=Selected_vars2[nvar]) +
theme(legend.position = "none") +
geom_rug(data=rug_data, aes(x=rug_data[, 1]), inherit.aes = FALSE) #+ geom_rug(col=rgb(.5,0,0,alpha=.2)) # + ggtitle(title)
} else if  (is.factor(obspred[, Selected_vars[nvar]])) {
pdp_plot1 <- ggplot(pd.all1, aes(x=pd.all1[, 1], y=pd.all1[, 2])) +
geom_point(size=3) + theme_pub  +labs(y="yhat", x=Selected_vars2[nvar]) +
theme(legend.position = "none") # + ggtitle(title)
}
print(pdp_plot1)
dev.copy(png, paste( i, km, Selected_vars[nvar],  "qrf_pdp.png", sep="_"), width=600, height=400)
dev.off()
} # nvars loop
# ### For the paper, visualize the 5 most important ones only
} # km loop
} # resp vars loop
all_varImp3 <- all_varImp[sort(all_varImp$Importance),]
all_varImp3
all_varImp
all_varImp <- all_varImp[order(all_varImp$Importance),]
all_varImp
all_varImp <- all_varImp[order(all_varImp$Importance, decreasing=TRUE),]
all_varImp
p1 <- ggplot(all_varImp) + geom_bar(aes(x=Variable2, y=Importance), stat="identity", color="blue")   +
coord_flip() +
theme_pub #+ ggtitle(title2)
p1
all_varImp
all_varImp$Variable2 <- factor(all_varImp$Variable2, levels=unique(all_varImp$Variable2))
p1 <- ggplot(all_varImp) + geom_bar(aes(x=Variable2, y=Importance), stat="identity")   +
coord_flip() +
theme_pub #+ ggtitle(title2)
p1
p1 <- ggplot(all_varImp) + geom_bar(aes(x=Variable2, y=Importance), stat="identity")   +
coord_flip() + scale_x_discrete(limits = rev(levels(all_varImp$Variable2)))+
theme_pub #+ ggtitle(title2)
p1
# change the name
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="srad_terraclimate_sites", "Solar radiation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="vpd_terraclimate_sites", "Vapor pressure deficit", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="pr_terraclimate_sites", "Precipitation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="pdsi_terraclimate_sites", "PDSI", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="tmean_TerraClimate_averages", "Mean annual air temperature over 1961-1990", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="ppt_TerraClimate_averages", "Mean annual precipitation over 1961-1990", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="trend_20yrprior_terra_change_id", "Rolling last 20-year air temperature trend", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="terra_trend_19601990", "Annual mean air temperature trend over 1961-1990", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="ndvi_trend_19812010", "June-August mean NDVI trend over 1982-2010", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Barrow_CO2_conc_Barrow_CO2conc", "Atmospheric CO2", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Snow.cover_era5_soilmoist_temp_snow", "Snow cover", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Snow.depth_era5_soilmoist_temp_snow", "Snow depth", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Soil.temperature.level.1_era5_soilmoist_temp_snow", "Soil temperature", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Volumetric.soil.water.layer.1_era5_soilmoist_temp_snow", "Volumetric soil water", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="NDVI_whittaker_constant_monthly_mean", "NDVI", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="LST_Day_1km_MOD11A2v006_LST_Day_sites_low_quality", "Land surface temperature (daytime)", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="water_ground_MCD43A4_annual_water_ground_sites_low_quality", "June-August average NDWI", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="water_vegetation_MCD43A4_annual_water_vegetation_sites_low_quality", "June-August average NDII", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="dtm_cti_merit.dem_m_250m_s0..0cm_2018_v1.0_MERIT_topo_indices_250m", "Compound topographic index", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="dtm_rough.scale_merit.dem_m_250m_s0..0cm_2018_v1.0_MERIT_topo_indices_250m", "Topographic roughness scale", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="aboveground_biomass_carbon_2010_Above_belowground_biomass", "Aboveground biomass", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="belowground_biomass_carbon_2010_Above_belowground_biomass", "Belowground biomass", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonTree_Vegetation_MOD44B_sites", "Percent non-tree vegetation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonVegetated_MOD44B_sites", "Percent-non-vegetated", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_Tree_Cover_MOD44B_sites", "Percent tree cover", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="ESACCI_cavm_general_ESAwaterfix_broadevfix_mixfix_cropfix_nowaterglacier_ESACCI_CAVM_merged", "Vegetation type", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="PHIHOX_M_sl1_250m_ll_SoilGrids", "Soil pH", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="BLDFIE_M_sl1_250m_ll_SoilGrids", "Soil bulk density", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="sol_watercontent.1500kPa_usda.3c2a1a_m_250m_b0..0cm_1950..2017_v0.1_SoilGrids_watercontent", "Soil water content", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Number_of_days_since_fire_classes_MCD64A1_sites_cleaned", "Time since fire", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="TKWP_Thermokarst", "Wetland thermokarst", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="TKHP_Thermokarst", "Hillslope thermokarst", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="forest_age_class_forest_age_sites", "Vegetation age", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="UiO_PEX_PERPROB_5.0_20181128_2000_2016_NH_UiO_PEX_20181128_2000_2016_NH", "Permafrost probability", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="SoilGrids_SOC_SoilGrids_SOCstock", "Soil organic carbon stock", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="SMMR_SSMIS_thaw_days_NTSG_FT_SMMR_SSMIS_25km", "Number of thaw days", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_TreeCover_AVHRR_VCF5KYR", "Percent tree cover", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonTree_Vegetation_AVHRR_VCF5KYR", "Percent non-tree vegetation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonVegetated_AVHRR_VCF5KYR", "Percent non-vegetated", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Number_of_days_since_fire_classes_gfed_monthly_calc", "Time since fire", all_varImp$Variable2)
all_varImp <- all_varImp[order(all_varImp$Importance, decreasing=TRUE),]
all_varImp$Variable2 <- factor(all_varImp$Variable2, levels=unique(all_varImp$Variable2))
p1 <- ggplot(all_varImp) + geom_bar(aes(x=Variable2, y=Importance), stat="identity")   +
coord_flip() + scale_x_discrete(limits = rev(levels(all_varImp$Variable2)))+
theme_pub #+ ggtitle(title2)
p1
# extract varimp results - this should work
all_varImp <- caret::varImp(mod$finalModel) %>% data.frame()
print("model loop done")
all_varImp$Variable2 <- row.names(all_varImp)
all_varImp$Importance <- all_varImp$Overall
# change the name
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="srad_terraclimate_sites", "Solar radiation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="vpd_terraclimate_sites", "Vapor pressure deficit", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="pr_terraclimate_sites", "Precipitation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="pdsi_terraclimate_sites", "PDSI", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="tmean_TerraClimate_averages", "Mean annual air temperature over 1961-1990", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="ppt_TerraClimate_averages", "Mean annual precipitation over 1961-1990", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="trend_20yrprior_terra_change_id", "Rolling last 20-year air temperature trend", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="terra_trend_19601990", "Annual mean air temperature trend over 1961-1990", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="ndvi_trend_19812010", "June-August mean NDVI trend over 1982-2010", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Barrow_CO2_conc_Barrow_CO2conc", "Atmospheric CO2", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Snow.cover_era5_soilmoist_temp_snow", "Snow cover", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Snow.depth_era5_soilmoist_temp_snow", "Snow depth", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Soil.temperature.level.1_era5_soilmoist_temp_snow", "Soil temperature", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Volumetric.soil.water.layer.1_era5_soilmoist_temp_snow", "Volumetric soil water", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="NDVI_whittaker_constant_monthly_mean", "NDVI", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="LST_Day_1km_MOD11A2v006_LST_Day_sites_low_quality", "Land surface temperature (daytime)", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="water_ground_MCD43A4_annual_water_ground_sites_low_quality", "June-August average NDWI", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="water_vegetation_MCD43A4_annual_water_vegetation_sites_low_quality", "June-August average NDII", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="dtm_cti_merit.dem_m_250m_s0..0cm_2018_v1.0_MERIT_topo_indices_250m", "Compound topographic index", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="dtm_rough.scale_merit.dem_m_250m_s0..0cm_2018_v1.0_MERIT_topo_indices_250m", "Topographic roughness scale", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="aboveground_biomass_carbon_2010_Above_belowground_biomass", "Aboveground biomass", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="belowground_biomass_carbon_2010_Above_belowground_biomass", "Belowground biomass", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonTree_Vegetation_MOD44B_sites", "Percent non-tree vegetation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonVegetated_MOD44B_sites", "Percent-non-vegetated", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_Tree_Cover_MOD44B_sites", "Percent tree cover", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="ESACCI_cavm_general_ESAwaterfix_broadevfix_mixfix_cropfix_nowaterglacier_ESACCI_CAVM_merged", "Vegetation type", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="PHIHOX_M_sl1_250m_ll_SoilGrids", "Soil pH", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="BLDFIE_M_sl1_250m_ll_SoilGrids", "Soil bulk density", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="sol_watercontent.1500kPa_usda.3c2a1a_m_250m_b0..0cm_1950..2017_v0.1_SoilGrids_watercontent", "Soil water content", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Number_of_days_since_fire_classes_MCD64A1_sites_cleaned", "Time since fire", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="TKWP_Thermokarst", "Wetland thermokarst", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="TKHP_Thermokarst", "Hillslope thermokarst", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="forest_age_class_forest_age_sites", "Vegetation age", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="UiO_PEX_PERPROB_5.0_20181128_2000_2016_NH_UiO_PEX_20181128_2000_2016_NH", "Permafrost probability", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="SoilGrids_SOC_SoilGrids_SOCstock", "Soil organic carbon stock", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="SMMR_SSMIS_thaw_days_NTSG_FT_SMMR_SSMIS_25km", "Number of thaw days", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_TreeCover_AVHRR_VCF5KYR", "Percent tree cover", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonTree_Vegetation_AVHRR_VCF5KYR", "Percent non-tree vegetation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonVegetated_AVHRR_VCF5KYR", "Percent non-vegetated", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Number_of_days_since_fire_classes_gfed_monthly_calc", "Time since fire", all_varImp$Variable2)
all_varImp <- all_varImp[order(all_varImp$Importance, decreasing=TRUE),]
all_varImp$Variable2 <- factor(all_varImp$Variable2, levels=unique(all_varImp$Variable2))
p1 <- ggplot(all_varImp) + geom_bar(aes(x=Variable2, y=Importance), stat="identity")   +
coord_flip() + scale_x_discrete(limits = rev(levels(all_varImp$Variable2)))+
theme_pub #+ ggtitle(title2)
# Print out
setwd("D:/repos/abcflux_modeling/results/figures/")
print(p1)
dev.copy(png, paste( i, km,  "qrf_vip.png", sep="_"), width=1300, height=1100)
dev.off()
all_varImp$Overall
# extract varimp results - this should work
all_varImp <- caret::varImp(mod$finalModel) %>% data.frame()
all_varImp
# extract varimp results - this should work
all_varImp <- caret::varImp(mod$finalModel, scale=TRUE) %>% data.frame()
all_varImp
# Load model files
mod <- readRDS(paste0("D:/repos/abcflux_modeling/results/", paste(i,  km, m, "train_loocv", sep="_"), ".rds"))
# extract varimp results - this should work
all_varImp <- caret::varImp(mod$finalModel, scale=TRUE) %>% data.frame()
all_varImp
ll_varImp <- importance(mod$finalModel, scale=TRUE) %>% data.frame()
varimp <- caret::varImp(mod$finalModel, scale=TRUE)
varimp
# extract varimp results - this should work
all_varImp <- caret::varImp(mod$finalModel, scale=TRUE) %>% data.frame()
print("model loop done")
all_varImp$Variable2 <- row.names(all_varImp)
all_varImp$Importance <- all_varImp$Overall
# change the name
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="srad_terraclimate_sites", "Solar radiation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="vpd_terraclimate_sites", "Vapor pressure deficit", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="pr_terraclimate_sites", "Precipitation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="pdsi_terraclimate_sites", "PDSI", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="tmean_TerraClimate_averages", "Mean annual air temperature over 1961-1990", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="ppt_TerraClimate_averages", "Mean annual precipitation over 1961-1990", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="trend_20yrprior_terra_change_id", "Rolling last 20-year air temperature trend", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="terra_trend_19601990", "Annual mean air temperature trend over 1961-1990", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="ndvi_trend_19812010", "June-August mean NDVI trend over 1982-2010", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Barrow_CO2_conc_Barrow_CO2conc", "Atmospheric CO2", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Snow.cover_era5_soilmoist_temp_snow", "Snow cover", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Snow.depth_era5_soilmoist_temp_snow", "Snow depth", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Soil.temperature.level.1_era5_soilmoist_temp_snow", "Soil temperature", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Volumetric.soil.water.layer.1_era5_soilmoist_temp_snow", "Volumetric soil water", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="NDVI_whittaker_constant_monthly_mean", "NDVI", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="LST_Day_1km_MOD11A2v006_LST_Day_sites_low_quality", "Land surface temperature (daytime)", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="water_ground_MCD43A4_annual_water_ground_sites_low_quality", "June-August average NDWI", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="water_vegetation_MCD43A4_annual_water_vegetation_sites_low_quality", "June-August average NDII", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="dtm_cti_merit.dem_m_250m_s0..0cm_2018_v1.0_MERIT_topo_indices_250m", "Compound topographic index", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="dtm_rough.scale_merit.dem_m_250m_s0..0cm_2018_v1.0_MERIT_topo_indices_250m", "Topographic roughness scale", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="aboveground_biomass_carbon_2010_Above_belowground_biomass", "Aboveground biomass", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="belowground_biomass_carbon_2010_Above_belowground_biomass", "Belowground biomass", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonTree_Vegetation_MOD44B_sites", "Percent non-tree vegetation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonVegetated_MOD44B_sites", "Percent-non-vegetated", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_Tree_Cover_MOD44B_sites", "Percent tree cover", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="ESACCI_cavm_general_ESAwaterfix_broadevfix_mixfix_cropfix_nowaterglacier_ESACCI_CAVM_merged", "Vegetation type", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="PHIHOX_M_sl1_250m_ll_SoilGrids", "Soil pH", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="BLDFIE_M_sl1_250m_ll_SoilGrids", "Soil bulk density", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="sol_watercontent.1500kPa_usda.3c2a1a_m_250m_b0..0cm_1950..2017_v0.1_SoilGrids_watercontent", "Soil water content", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Number_of_days_since_fire_classes_MCD64A1_sites_cleaned", "Time since fire", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="TKWP_Thermokarst", "Wetland thermokarst", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="TKHP_Thermokarst", "Hillslope thermokarst", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="forest_age_class_forest_age_sites", "Vegetation age", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="UiO_PEX_PERPROB_5.0_20181128_2000_2016_NH_UiO_PEX_20181128_2000_2016_NH", "Permafrost probability", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="SoilGrids_SOC_SoilGrids_SOCstock", "Soil organic carbon stock", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="SMMR_SSMIS_thaw_days_NTSG_FT_SMMR_SSMIS_25km", "Number of thaw days", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_TreeCover_AVHRR_VCF5KYR", "Percent tree cover", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonTree_Vegetation_AVHRR_VCF5KYR", "Percent non-tree vegetation", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Percent_NonVegetated_AVHRR_VCF5KYR", "Percent non-vegetated", all_varImp$Variable2)
all_varImp$Variable2 <- ifelse(all_varImp$Variable2=="Number_of_days_since_fire_classes_gfed_monthly_calc", "Time since fire", all_varImp$Variable2)
all_varImp <- all_varImp[order(all_varImp$Importance, decreasing=TRUE),]
all_varImp$Variable2 <- factor(all_varImp$Variable2, levels=unique(all_varImp$Variable2))
p1 <- ggplot(all_varImp) + geom_bar(aes(x=Variable2, y=Importance), stat="identity")   +
coord_flip() + scale_x_discrete(limits = rev(levels(all_varImp$Variable2)))+
theme_pub #+ ggtitle(title2)
# selected vars
if (km=="1km") {
Selected_vars <- Baseline_vars_1km
} else {
Selected_vars <- Baseline_vars_20km
}
nvars <- length(Selected_vars)
nvars
# model training data
# Add data
# remove NA across columns for 1 and 20 km datasets
modeldata2 <- d[,c("Study_ID_Short", "id", i, Baseline_vars_1km)]
modeldata1 <- na.omit(modeldata2) # only 86 obs
sapply(modeldata1, function(x) sum(is.na(x))) # no missing data
print("1 km data set:")
print(nrow(modeldata1))
modeldata2 <- d[,c("Study_ID_Short", "id", i, Baseline_vars_20km)]
modeldata2 <- na.omit(modeldata2) # only 86 obs
sapply(modeldata2, function(x) sum(is.na(x))) # no missing data
print("20 km data set:")
print(nrow(modeldata2))
# create a row ID
modeldata1$samplerow <- seq(1, length(modeldata1$Study_ID_Short), by=1)
# create a row ID
modeldata2$samplerow <- seq(1, length(modeldata2$Study_ID_Short), by=1)
# # Extract the final model details: GBM
preds <- mod$pred %>% data.frame()
if (km=="1km") {
obspred <- merge(modeldata1, preds, by.x="samplerow", by.y="rowIndex")
#plot(obspred$NEE_gC_m2, obspred$obs)
} else {
obspred <- merge(modeldata2, preds, by.x="samplerow", by.y="rowIndex")
#plot(obspred$NEE_gC_m2, obspred$obs)
}
nvar <- 1
pd1 <- partial(mod, pred.var = Selected_vars[nvar], train=obspred)  # don't set plot = TRUE
rug_data <- obspred[Selected_vars[nvar]]
# variable names
# change the name
Selected_vars2 <- Selected_vars
Selected_vars2 <- ifelse(Selected_vars2=="srad_terraclimate_sites", "Solar radiation/10 W m-2	", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="vpd_terraclimate_sites", "Vapor pressure deficit/100 kPa", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="pr_terraclimate_sites", "Precipitation mm", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="pdsi_terraclimate_sites", "PDSI/100", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="tmean_TerraClimate_averages", "Mean annual air temperature over 1961-1990 °C", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="ppt_TerraClimate_averages", "Mean annual precipitation over 1961-1990 mm", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="trend_20yrprior_terra_change_id", "Rolling last 20-year air temperature trend/10 °C", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="terra_trend_19601990", "Annual mean air temperature trend over 1961-1990/10 °C", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="ndvi_trend_19812010", "June-August mean NDVI trend over 1982-2010", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Barrow_CO2_conc_Barrow_CO2conc", "Atmospheric CO2", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Snow.cover_era5_soilmoist_temp_snow", "Snow cover %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Snow.depth_era5_soilmoist_temp_snow", "Snow depth m", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Soil.temperature.level.1_era5_soilmoist_temp_snow", "Soil temperature Kelvin", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Volumetric.soil.water.layer.1_era5_soilmoist_temp_snow", "Volumetric soil water m3 m-3", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="NDVI_whittaker_constant_monthly_mean", "NDVI", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="LST_Day_1km_MOD11A2v006_LST_Day_sites_low_quality", "Land surface temperature (daytime) Kelvin", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="water_ground_MCD43A4_annual_water_ground_sites_low_quality", "June-August average NDWI", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="water_vegetation_MCD43A4_annual_water_vegetation_sites_low_quality", "June-August average NDII", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="dtm_cti_merit.dem_m_250m_s0..0cm_2018_v1.0_MERIT_topo_indices_250m", "Compound topographic index", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="dtm_rough.scale_merit.dem_m_250m_s0..0cm_2018_v1.0_MERIT_topo_indices_250m", "Topographic roughness scale", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="aboveground_biomass_carbon_2010_Above_belowground_biomass", "Aboveground biomass MgC ha-1", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="belowground_biomass_carbon_2010_Above_belowground_biomass", "Belowground biomass MgC ha-1", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Percent_NonTree_Vegetation_MOD44B_sites", "Percent non-tree vegetation %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Percent_NonVegetated_MOD44B_sites", "Percent-non-vegetated %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Percent_Tree_Cover_MOD44B_sites", "Percent tree cover %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="ESACCI_cavm_general_ESAwaterfix_broadevfix_mixfix_cropfix_nowaterglacier_ESACCI_CAVM_merged", "Vegetation type", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="PHIHOX_M_sl1_250m_ll_SoilGrids", "Soil pH", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="BLDFIE_M_sl1_250m_ll_SoilGrids", "Soil bulk density kg m-3", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="sol_watercontent.1500kPa_usda.3c2a1a_m_250m_b0..0cm_1950..2017_v0.1_SoilGrids_watercontent", "Soil water content %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Number_of_days_since_fire_classes_MCD64A1_sites_cleaned", "Time since fire (no burn - old burn)", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="TKWP_Thermokarst", "Wetland thermokarst (low - high coverage)", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="TKHP_Thermokarst", "Hillslope thermokarst (low - high coverage)", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="forest_age_class_forest_age_sites", "Vegetation age (old - young)", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="UiO_PEX_PERPROB_5.0_20181128_2000_2016_NH_UiO_PEX_20181128_2000_2016_NH", "Permafrost probability %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="SoilGrids_SOC_SoilGrids_SOCstock", "Soil organic carbon stock Tonnes ha-1", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="SMMR_SSMIS_thaw_days_NTSG_FT_SMMR_SSMIS_25km", "Number of thaw days", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Percent_TreeCover_AVHRR_VCF5KYR", "Percent tree cover %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Percent_NonTree_Vegetation_AVHRR_VCF5KYR", "Percent non-tree vegetation %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Percent_NonVegetated_AVHRR_VCF5KYR", "Percent non-vegetated %", Selected_vars2)
Selected_vars2 <- ifelse(Selected_vars2=="Number_of_days_since_fire_classes_gfed_monthly_calc", "Time since fire (no burn - old burn)", Selected_vars2)
if (!is.factor(obspred[, Selected_vars[nvar]])) {
pdp_plot1 <- ggplot(pd.all1, aes(x=pd.all1[, 1], y=pd.all1[, 2])) +
geom_line(size=1) + theme_pub  +labs(y="yhat", x=Selected_vars2[nvar]) +
theme(legend.position = "none") +
geom_rug(data=rug_data, aes(x=rug_data[, 1]), inherit.aes = FALSE) #+ geom_rug(col=rgb(.5,0,0,alpha=.2)) # + ggtitle(title)
} else if  (is.factor(obspred[, Selected_vars[nvar]])) {
pdp_plot1 <- ggplot(pd.all1, aes(x=pd.all1[, 1], y=pd.all1[, 2])) +
geom_point(size=3) + theme_pub  +labs(y="yhat", x=Selected_vars2[nvar]) +
theme(legend.position = "none") # + ggtitle(title)
}
print(pdp_plot1)
if (!is.factor(obspred[, Selected_vars[nvar]])) {
pdp_plot1 <- ggplot(pd1, aes(x=pd1[, 1], y=pd1[, 2])) +
geom_line(size=1) + theme_pub  +labs(y="yhat", x=Selected_vars2[nvar]) +
theme(legend.position = "none") +
geom_rug(data=rug_data, aes(x=rug_data[, 1]), inherit.aes = FALSE) #+ geom_rug(col=rgb(.5,0,0,alpha=.2)) # + ggtitle(title)
} else if  (is.factor(obspred[, Selected_vars[nvar]])) {
pdp_plot1 <- ggplot(pd1, aes(x=pd1[, 1], y=pd1[, 2])) +
geom_point(size=3) + theme_pub  +labs(y="yhat", x=Selected_vars2[nvar]) +
theme(legend.position = "none") # + ggtitle(title)
}
print(pdp_plot1)
